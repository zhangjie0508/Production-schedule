# 生产排期代码逻辑
## 1. 读取表格数据 📊📥

## 2. 处理差异化和已完成订单 ✅📌

- 从原表单筛选 **“差异化”** 和 **“已完成”** 订单 ✂️，按原格式移到 **“其他”** 表单 📂，避免影响后续排序和操作 🚀。

## 3. 处理材料材质“来料”前缀 🔄

- 当材质中有 **“来料”** 前缀时 ✂️ 去掉，但输出时要加回去 🎯。

## 4. 分配设备 🏭⚙️

### （1）处理异型管订单 🛠️

- **初始化设备列** 🆕📊
- 默认 **异型管机1** 和 **异型管机2** 负荷都是 **0** ⚖️。
- 过滤出 **直管、差异化订单** 🚦。
- **按材料厚度降序排序** 📉，确保 **厚的订单优先分配** 🎯📌。

🔍 **数据检查**（确保计算不出错 🚨）：

- **材料厚度** → `float64`（浮点数）🔢
- **未完成数量** → `float64`（浮点数）📊
- **材料材质** → `string`（字符串）🔠

📌 **遍历订单、异型管分配规则**：

- 如果 **厚度不在** `{0.5, 0.75, 0.6, 0.8, 1.0}` **范围内** 或者 **材质包含“不锈钢”**，强制分配到 **异型管机2** 🚨🛠️。
- **如果相同厚度 & 相同材质的订单已分配** —— **沿用原设备** 🔄⚖️。
- **厚度 ≥ 1.0** 或 **异型管机2 负载 ≤ 异型管机1 负载** —— **优先选“异型管机2”** ✅。

### （2）处理直管设备 🏗️

- **加工工艺是直管的 → 直接分配给直管机** 🚀。

## 5. 排序 📌🔢

### （1）预计交期转换格式 (`convert_due_date`) ⏳📅

- 解析预计交期格式，如 **`3.22 15:00`**，转换为 **`2025-03-22 15:00`** 🔄。
- 处理方式：
  - ✂️ **去除空格**
  - 🔄 **修正中文冒号**（防止格式问题）
  - ⚠️ **防止异常日期**，解析失败返回 `NaT` 🚨。

------

### （2）交期排序 📆📊

- 填充 **`NaT`** 为 **`2100-01-01`** 🏷️（确保无交期的订单永远排在最后 🏁）。
- 创建 **“是否有交期”** 列，标记订单：✅ `1=有交期` ❌ `0=无交期`。

------

### （3）组内排序 🗂️🔄

- **分组依据** 🏷️：设备 🏭、材料厚度 📏、材料材质 🏗️。
- 创建 **“组1”** 列，标识 **相同设备、厚度、材质的订单属于同一组** 🏷️📊。

------

### （4）计算组的最早交期 📆⏳

- 组内 **排除无交期订单**，取最小交期值 (`min`) 🔽📆。
- 确保 **“组最早交期”** 格式为 `datetime` ⏳📅。

------

### （5）排序逻辑 📝🔢

| 排序字段       | 作用             | 方向 ⬆⬇    |
| -------------- | ---------------- | ---------- |
| **组最早交期** | 组按最早交期排序 | **升序 ⬆** |
| **材料材质**   | 材质一致性       | **升序 ⬆** |
| **材料厚度**   | 厚度一致性       | **升序 ⬆** |
| **是否有交期** | 有交期优先       | **降序 ⬇** |
| **交期排序**   | 具体交期排序     | **升序 ⬆** |

🔹 **确保**：
 ✅ 相同材质 & 厚度的订单排在一起 📌。
 ✅ **有交期** 的订单优先处理 ⏳✅。
 ✅ **最早交期的组优先** 📆🏅。

------

### （6）判断是否换料 🔄🛠️

- **设备 / 材质 / 厚度 发生变化** 就需要 **换料** 🔧⏳。

------

### （7）异型管机2排序 ⚙️🔄

- 增加列 **“异型管机1不可生产”**（`True` = **1号机无法生产的订单** 🚫🛠️）。
- 排序逻辑 📝：
  1. **异型管机1不可生产** 👉 让 **1号机无法生产的订单优先排** 📌。
  2. **组最早交期** 👉 组内最早交期优先 📆📊。
  3. **材料材质 & 材料厚度** 👉 让相同材质、厚度的订单排在一起 📌📊。
  4. **是否有交期** 👉 **有交期的订单优先** ✅📅。
  5. **交期排序** 👉 具体交期时间排序 🕒⬆。

🔄 **重新合并 `df`**：

- 先 **删除** `df` 里的 **异型管机2** 数据 🗑️。
- 用 `concat` 方式 **重新合并 `df_yixing2`**（已经排序）🔗📊。

------

### （8）更新是否换料 🔄⏳

- **只要** 设备 ⚙️、材料厚度 📏、材料材质 🏗️ **发生变化**，就标记 **“是”** ✅🔄。
- `.shift()` 作用：**检查与前一行是否相同** 🧐📊。

------

### （9）计算组1 & 组2 📊🔢

- **组1** 👉 相同 **设备、厚度、材质** 的订单分为一组（`ngroup()` 赋值）🔢📊。
- **组2** 👉 基于 **组1** 进行编号（`factorize()`），序号从 `0` 开始 **连续排序** 🔄🔢。

## 6. 计算生产时间、生产开始时间、生产结束时间 📊⏳

### **（1）计算生产时间** (`calculate_production_time`) ⏱️🔢

不同设备的 **生产速率**：

- **直管机** → 90件/小时
- **异型管机1** → 50平方/小时
- **异型管机2** → 80平方/小时

计算逻辑：

- **直管**：生产件数 ÷ 90（小时）
- **异型管**：未完成数量 ÷ 50/80
- 计算出的 **总分钟数** 转换为 **"X小时 Y分钟"** ⏳。

------

### **（2）获取下一个可用的工作班次** (`get_next_available_shift`) 🏭🔄

- 遍历 **`work_shifts`** 计算 **最近的可用班次** 📆。
- **跨天处理** ✅：
  - 如 `"21:00 - 08:00"` 属于 **跨天班次**，需要正确计算结束时间。
- **返回值**：
  - 📌 **班次开始时间**
  - ⏳ **班次结束时间**
  - ⏰ **当前班次可用的剩余分钟数**

------

### **（3）处理休息时间** (`is_in_break_time`) 😴🚦

- 判断 **当前时间** 是否处于 **休息时间段**：
  - `"12:00 - 13:30"`（午休）
  - `"17:30 - 18:00"`（晚餐）
  - `"21:00 - 08:00"`（夜休）
- **如果当前时间在休息时间内**，返回 **休息结束时间** ⏳，否则返回 `None`。

------

### **（4）生产调度 & 生产时间安排** 🛠️⏳

**核心逻辑**： 1️⃣ **初始化** 设备的 **生产起始时间**（默认 `2025-03-21 08:00`）。
 2️⃣ **换料处理**：

- 如果 `是否换料 == "是"`，增加 **15分钟换料时间** 🛠️。
   3️⃣ **解析生产时间**：
- **提取 "X小时 Y分钟"** 转换为 **总分钟数** ⏳。
   4️⃣ **生产时间安排**：
- **休息时间处理**：
  - 如果 `start_time` 处于 **休息时间**，则 **跳到休息结束时间** 🕒。
- **班次检查**：
  - 获取 **当前班次可用时间** ⏳，如果不足，**进入下一个班次** 🏭。
- **生产拆分**：
  - 如果 **剩余生产时间 > 当前班次剩余时间** → **拆分生产** 🛠️。 5️⃣ **更新数据**：
- **生产开始时间** → 记录 **第一段生产的 `start_time`**。
- **生产结束时间** → 记录 **最后一段生产的 `end_time`**。
- **更新 `device_last_end_time`**，**确保设备不会重叠生产** ⚙️。

## **7. 计算项目交付时间** 📆🚚

1️⃣ **以订单编号分组**：

- 使用 `groupby("订单编号")`，确保**同一个订单的所有批次被归为一组**。

2️⃣ **计算订单的最终交付时间**：

- `transform("max")` 找到**该订单所有生产批次的最晚生产结束时间**。
- 确保“项目交付时间”列格式为 `datetime` 类型，避免排序出错。

3️⃣ **去重，确保订单唯一性**：

- 只保留 **订单编号 & 交付时间**，确保 **一个订单只显示一次** 📌。

4️⃣ **按交付时间排序**：

- **升序排序**（最早交付的订单排在前面）。
- 遇到 `NaT`（无交期），默认替换成**远未来日期**（如 `2100-01-01`），确保它们排在最后。

## **8. 判断是否逾期交付** ⏳📌

1️⃣ **无预计交期**（`NaT`）→ **默认按时交付** ✅
2️⃣ **预计交期 >= 生产结束时间** → **按时交付** ✅
3️⃣ **预计交期 < 生产结束时间** → **逾期交付** ❌

## **9. 格式化日期** 📅✨

- 将 `df` 和 `project_delivery_df` 中的日期字段统一转换为指定的格式。 🎯
  - 下单日期格式化为 **`YYYY-MM-DD`** 🗓️
  - 预计交期、生产开始时间和生产结束时间格式化为 **`YYYY-MM-DD HH:MM`** ⏳✅

## **10. 恢复“材料材质”字段的值** 🔄🛠️

- 使用 `restore_material` 函数，根据每行的 **原始材料材质** 和 **材料材质** 恢复数据。

## **11. 删除临时列** 🗑️✨

- 删除不再需要的 **原始材料材质** 列，保持数据简洁。

## **12. 美化 Excel 表格输出** 🎨📊

- **📏 自动调整列宽**：计算每列的最大字符长度，自动调整列宽。
- **📌 单元格格式化**：设置所有单元格为**居中对齐**，添加**边框**。
- **🚨 逾期交付标注红色**：如果“按时交付检查”列值为“逾期交付”，则填充**红色背景**。
- **🔠 表头加粗**：设置表头单元格字体**加粗**。

## **13. 生成 Excel 文件** 📂📈

- **🛠️ 根据设备类型将数据分配到不同的工作表**（如“直管机”📏，“异型管机1”🔧，“异型管机2”⚙️）。
- **📋 每个工作表只包含需要的列**。
- **📆 输出“项目交付时间”⏳ 和“其他”📄 工作表**。

## **14. 应用美化处理** ✨🎨

- 对生成的 Excel 文件进行格式化处理，包括：
  - **列宽调整** 📏⚖️
  - **居中对齐** ↔️📍
  - **添加边框** 🔲🖊️
  - **逾期交付标注红色背景** 🔥📅
